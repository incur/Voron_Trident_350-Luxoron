[gcode_macro CHANGE_FILAMENT]
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _SELF_VARIABLES"].print_default_extruder_temp)|float %}
    {% set DISTANCE = params.DISTANCE|default(105)|float %}

    SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
    PAUSE
    UNLOAD_FILAMENT TEMP={TEMP} DISTANCE={DISTANCE}
    RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _SELF_VARIABLES"].print_default_extruder_temp)|float %}
    {% set DISTANCE = params.DISTANCE|default(105)|float %}

    {% set re_enable_filament_sensor = 0 %}

    SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
    SET_FILAMENT_SENSOR SENSOR="toolhead_sensor" ENABLE=0
    
    {% set re_enable_filament_sensor = 1 %}

    SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
    _LOW_TEMP_CHECK T={TEMP}
    
    _TIP_SHAPING
    M83
    G1 E-20 F3600
    G4 P3000
    G1 E{DISTANCE|float * -1} F3000
    M400

    CLEAR_ACTIVE_SPOOL
    RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state

    {% if re_enable_filament_sensor %}
        SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
        SET_FILAMENT_SENSOR SENSOR="toolhead_sensor" ENABLE=1
    {% endif %}

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _SELF_VARIABLES"].print_default_extruder_temp)|float %}
    {% set tip_distance = printer["gcode_macro _KAMP_Settings"].tip_distance | float %}
    {% set DISTANCE = params.DISTANCE|default(105)|float %}

    SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
    SET_FILAMENT_SENSOR SENSOR="toolhead_sensor" ENABLE=0
    
    {% set re_enable_filament_sensor = 1 %}
    SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
    _LOW_TEMP_CHECK T={TEMP}

    M83
    G92 E0
    G1 E{DISTANCE|float} F200
    G1 E50 F150
    G1 E-{tip_distance} F2100

    M400
    G92 E0

    RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
    {% if re_enable_filament_sensor %}
        SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
        SET_FILAMENT_SENSOR SENSOR="toolhead_sensor" ENABLE=1
    {% endif %}


[gcode_macro _TIP_SHAPING]
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _SELF_VARIABLES"].print_default_extruder_temp)|float %}
    
    SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
    SET_FILAMENT_SENSOR SENSOR="toolhead_sensor" ENABLE=0
    
    {% set re_enable_filament_sensor = 1 %}
    SAVE_GCODE_STATE NAME=TIP_SHAPING_state
    _LOW_TEMP_CHECK T={TEMP}

    {% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
    SET_PRESSURE_ADVANCE ADVANCE=0

    M82
    G92 E0
    G1 E2 F3600
    G1 E0 F3600
    G1 E3 F3600
    G1 E0 F3600
    G1 E4 F3600
    G1 E0 F3600

    SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
    M400

    RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
    SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
    SET_FILAMENT_SENSOR SENSOR="toolhead_sensor" ENABLE=1
